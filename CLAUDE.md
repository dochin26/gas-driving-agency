# Claude Code Configuration

## 概要
このアプリケーションは運転代行の営業で使用する情報を管理するためのものです。
ユーザーはLine Messaging APIを通じてデータのやり取りを行います。
送信されたデータはGoogle Apps Scriptを通じてスプレッドシートへ保存されます。

## 前提条件
回答は日本語で行ってください。
セルに記録する日時は``yyyy/MM/dd HH:mm``とする。
ユーザーが日時を指定するときは``yyyy/MM/dd HHmm``（入力）または``yyyy/MM/dd``とする。

## 引用
作成するにあたり、以下のドキュメントやWebページを参照すること。
* BUTTON_UI.md リッチメニュー用のボタンデザイン
* SPSHE.md 編集するスプレッドシートのURL
* README.md アプリケーションの説明ファイル

## リッチボタン
LINEの機能であるリッチボタンの作成をすること。
tableはイメージであり、タイトル部分１行目のデザインは無視する。
ボタンの色、文字の大きさは任意とするが決定したらBUTTON_UI.mdに仕様を定義すること。

## 日報
指定した日の情報を引き出す。
リッチボタンを押すと以下の通り、動作する。

### 日報の動作フロー
1. 年月日の選択
   - 当日から１週間前までの年月日をボタンテンプレートで用意する
   - 運転代行は日を跨ぐ業務なので当日の設定は日報範囲設定からスコープする
   - 例：年月日が2025/12/1、日報範囲設定が開始19、終了28なら2025/12/1 19:00から2025/12/2 4:00までとなる
   - ボタンテンプレートにない日時は直接入力する

2. 車両番号の選択
   - 車両設定シートから車両番号をボタンテンプレートで用意する

3. 条件に該当するレコードを出力
   - 対象カラム：No以外全て（出発日時、出発地点、店舗名、経由地、到着日時、目的地、走行距離、金額、車両番号、備考）
   - 出発日時、到着日時は時間も出力すること
   - **Flex Message（Bubble形式）**で複数件を縦に並べて表示
   - 各Bubbleに1件の運転記録を表示

4. 当該日の走行距離と合計金額を出力
   - 全件の後に合計を表示

### 日報のFlex Message仕様（Bubble形式）
- 1件ごとにBubbleで表示
- 複数件ある場合は縦に並べて表示
- 各Bubbleに以下を含む：
  - 出発日時（時間含む）
  - 出発地点
  - 店舗名
  - 経由地
  - 到着日時（時間含む）
  - 目的地
  - 走行距離
  - 金額
  - 車両番号
  - 備考
- 最後に合計Bubbleを表示：
  - 走行距離の合計
  - 金額の合計
- **該当データが0件の場合**：「本日のデータはありません」と返信

## 取消
進行中の作業を中断する時に使用します。
ボタンが押されたら、確認テンプレートを使用して最終確認してください。
確認テンプレートを使用せずいきなり中断しないでください。

## 現在地
現在地の情報をスマホから座標を取得し、Google Apps Scriptに送ってください。
Google Apps Scriptは座標から住所に変換し、その値をスプレッドシートへ反映してください。

### 仕様
- LINEのLocation Messageを使用して位置情報を取得
- 有効な項目：出発地点、経由地、目的地
- 無効な項目：上記以外の入力中は現在地ボタンを無効化
- 座標から住所への変換：Google Apps ScriptのMaps APIを使用

## 戻る
新規・日報の進行中に前の項目に戻る際使用します。

## 新規
運転代行の新規案件を登録する際に使用します。
動作フローは別に用意しているのでそれを参照してください。

## 進む
新規の進行中の項目を空の値とし、先の項目へ行く場合に使用します。
日報を含め、新規以外は使用できないようにしてください。

## スプレッドシート構成

### 運転記録シート
| A列 | B列 | C列 | D列 | E列 | F列 | G列 | H列 | I列 | J列 | K列 |
|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|-----|
| No | 出発日時 | 出発地点 | 店舗名 | 経由地 | 到着日時 | 目的地 | 走行距離 | 金額 | 車両番号 | 備考 |

- **No列の自動採番**：新規レコード追加時、既存の最大No + 1を自動付与

### ユーザー管理シート
| A列 | B列 | C列 | D列 | E列 |
|-----|-----|-----|-----|-----|
| No | LINE User ID | 現在の状態 | 一時データ | 最終更新日時 |

- **No列の自動採番**：新規ユーザー追加時、既存の最大No + 1を自動付与
- 現在の状態：入力待ち項目（例：出発地点入力中、店舗名入力中、経由地入力中、到着日時入力中、目的地入力中、走行距離入力中、金額入力中、車両番号入力中、備考入力中、日報_日付選択中、日報_車両選択中）
- 一時データ：入力途中のデータをJSON形式で保存
- 最終更新日時：yyyy/MM/dd HH:mm 形式、タイムアウト判定用

### 車両設定シート
| A列 | B列 | C列 |
|-----|-----|-----|
| No | 車両番号 | 車両情報 |

- **No列の自動採番**：新規車両追加時、既存の最大No + 1を自動付与
- 車両情報：車種名（例：プリウス、アルファードなど）

### 店舗登録シート
| A列 | B列 | C列 |
|-----|-----|-----|
| No | 店舗名 | 住所 |

- **No列の自動採番**：新規店舗追加時、既存の最大No + 1を自動付与

### 日報範囲設定シート
| A列 | B列 | C列 |
|-----|-----|-----|
| No | 開始 | 終了 |

- 2行目に1件のみデータが入る
- 開始・終了：時刻を表す数値（0-23）
- 例：開始19、終了28（翌日4時）の場合、19:00から翌日4:00までが1日の範囲

## 状態管理
ユーザーの入力状態は「ユーザー管理」シートで管理する。

### 状態遷移ルール
- 「戻る」ボタン：前の状態に戻るが、既に入力したデータは破棄される（一時データから該当項目を削除）
- 「進む」ボタン：現在の項目を空値として次の状態へ進む（一時データに空値を設定）
- 「取消」ボタン：確認テンプレートで最終確認後、状態と一時データを全て削除
- 登録完了：全ての入力が完了したら、状態と一時データを削除

## データ検証
### 必須項目
出発日時、店舗名、到着日時、目的地、走行距離、金額、車両番号

### 任意項目
出発地点、経由地、備考

### 入力形式の検証とエラー処理
- 日時形式（入力）：yyyy/MM/dd または yyyy/MM/dd HHmm 以外はエラー
- 日時形式（保存）：yyyy/MM/dd HH:mm に正規化して保存
- 数値（走行距離・金額）：数値以外はエラー
- 全角数字：半角に自動変換してから検証
- エラー時：「入力形式が正しくありません。もう一度入力してください。」とメッセージを返す

## 新規の動作フロー
1. 出発地点の住所
   - 新規が押された段階の日時を出発日時に反映する
   - 現在地もしくは手入力で登録する

2. 店舗名（必須）
   - 手入力で店舗名を登録する
   - 店舗登録シートに記載がある場合、店舗名をボタンテンプレートで表示する
   - ボタンテンプレートが押されたら、店舗名は店舗名、住所は出発地点に反映する

3. 経由地
   - 現在地または手入力で反映する

4. 到着日時（必須）
   - ボタンテンプレートで``目的地に到着``を表示し、押された時間を到着日時に反映する

5. 目的地（必須）
   - 現在地または手入力で反映する

6. 走行距離（必須）
   - 手入力で数値を反映する

7. 金額（必須）
   - 手入力で数値を反映する

8. 車両番号（必須）
   - ボタンテンプレートで車両設定シートからボタンを生成（車両番号のみ表示）
   - または手入力で値を反映する
   - 運転記録シートには車両番号のみ保存される（車両情報は保存されない）

9. 備考
   - 引き継ぎ事項など手入力して値を反映する

10. 登録完了
    - 全ての入力が完了したら、**Flex Message（Transit形式）**で登録内容を1件表示
    - 「登録する」「修正する」のボタンを表示
    - 「登録する」が押されたら：
      - 運転記録シートに保存（Noは自動採番）
      - ユーザー管理シートの状態と一時データを削除
      - 「登録が完了しました」とメッセージを返信
    - 「修正する」が押されたら：
      - 備考の入力まで戻る（一時データは保持）
      - ユーザーは「戻る」ボタンで任意の項目まで戻れる

### 新規登録のFlex Message仕様（Transit形式）
- 登録完了時に1件のみ表示
- Transit形式で出発地から目的地までの流れを視覚的に表現
- 表示項目：
  - 出発日時（時間含む）
  - 出発地点
  - 店舗名
  - 経由地
  - 到着日時（時間含む）
  - 目的地
  - 走行距離
  - 金額
  - 車両番号
  - 備考
- 最下部にアクションボタン：
  - 「登録する」ボタン（緑系）
  - 「修正する」ボタン（グレー系）

## 削除

### 削除の動作フロー
1. 「削除」ボタンを押す

2. 日時を選択
   - 当日から1週間前までの日付（yyyy/mm/dd）をボタンテンプレートで表示
   - ボタンテンプレートにない日時は手入力

3. 絞り込み条件を選択
   - 時間（HH）で絞る、または店舗名で絞る
   - ボタンテンプレートまたは手入力で選択

4. 条件に該当するレコードをBubble形式で表示
   - 各Bubbleに「削除」ボタンを配置

5. 削除ボタンが押されたら確認テンプレート表示
   - 「以下のレコードを削除しますか？」
   - 削除対象の詳細（店舗名、出発日時、到着日時、金額など）を表示
   - 「削除する」「キャンセル」ボタン

6. 「削除する」が押されたら削除実行
   - 運転記録シートから該当行を削除
   - 「削除が完了しました」と返信
   - ユーザー管理シートの状態をリセット

## 編集

### 編集の動作フロー
1. 「編集」ボタンを押す

2. 日時を選択
   - 当日から1週間前までの日付（yyyy/mm/dd）をボタンテンプレートで表示
   - ボタンテンプレートにない日時は手入力

3. 絞り込み条件を選択
   - 時間（HH）で絞る、または店舗名で絞る
   - ボタンテンプレートまたは手入力で選択

4. 条件に該当するレコードをBubble形式で表示
   - 各Bubbleに「編集」ボタンを配置

5. 編集したいレコードを選択

6. 編集する項目を選択
   - ボタンテンプレートで全項目を表示（出発日時、出発地点、店舗名、経由地、到着日時、目的地、走行距離、金額、車両番号、備考）

7. 新しい値を入力
   - 入力形式の検証を実施（必須項目チェック、日時・数値の形式チェック）

8. 他の項目も編集するか確認
   - 「他の項目も編集する」→ 手順6に戻る
   - 「編集完了」→ 確認画面へ

9. Transit形式で編集内容を表示
   - 「更新する」「修正する」ボタン

10. 「更新する」が押されたら更新実行
    - 運転記録シートを更新
    - 「更新が完了しました」と返信
    - ユーザー管理シートの状態をリセット

11. 「修正する」が押されたら
    - 手順6に戻る（一時データは保持）

## リッチメニューのボタン配置
- **アイドリング時**（何も操作していない時）：
  - 新規、日報、削除、編集、現在地、取消を表示
  - 進む、戻るは無効（削除・編集をこのスペースに配置）

- **新規入力中・日報選択中・削除選択中・編集選択中**：
  - 進む、戻る、現在地、取消を表示
  - 削除、編集は非表示

## エラーハンドリング

### 通信エラー（LINE ⇔ Google Apps Script）
- 発生時：「通信エラーが発生しました。もう一度お試しください。」と返信
- 状態と一時データは保持

### スプレッドシートアクセスエラー
- 読み取りエラー：「データの読み取りに失敗しました。しばらく経ってからお試しください。」と返信
- 書き込みエラー：「データの保存に失敗しました。もう一度お試しください。」と返信
- 一時データは保持

### Google Maps APIエラー（座標→住所変換失敗）
- 座標をそのまま保存
- エラーメッセージは表示しない

### 入力形式エラー
- 日時形式：yyyy/mm/dd または yyyy/mm/dd hhmm 以外はエラー
- 数値（走行距離・金額）：数値以外はエラー
- 全角数字：半角に自動変換してから検証
- エラー時：「入力形式が正しくありません。もう一度入力してください。」と返信

## タイムアウト処理

### 新規登録中のタイムアウト
- タイムアウト時間：最終更新日時から30分
- タイムアウト後、次にユーザーがメッセージを送った時：
  ```
  前回の入力（○○入力中）が残っています。
  続きから入力しますか？

  [続きから入力] [最初から]
  ```
  - 「続きから入力」：一時データを保持して続行
  - 「最初から」：一時データと状態を削除してリセット

- 日報、削除、編集の操作中はタイムアウト処理なし（状態は残り続ける）

## 複数ユーザー対応
- 想定ユーザー数：2-5人
- LINE User IDで各ユーザーを識別
- 各ユーザーは独立して入力・操作可能
- ユーザー管理シートで各ユーザーの状態を個別管理

## Development Commands

```bash
# Push local changes to Google Apps Script
clasp push

# Pull changes from Google Apps Script
clasp pull

# Open script in web editor
clasp open
```

## Architecture

- **Runtime**: V8 (configured in `appsscript.json`)
- **Timezone**: Asia/Tokyo
- **Logging**: STACKDRIVER for exception logging
- **Script ID**: Configured in `.clasp.json`
